<div class="min-h-screen bg-surface py-8">
  <div class="container-lg mx-auto px-4">
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-primary mb-2">编辑名片信息</h1>
      <p class="text-secondary">更新您的专业名片展示内容</p>
    </div>

    <div class="card">
      <div class="card-body">
        <%= form_with model: @profile, url: settings_dashboards_path, method: :patch, local: true, class: "space-y-6" do |form| %>
          <%= render 'shared/form_error_message', model: @profile %>

          <!-- Basic Information -->
          <div class="space-y-4">
            <h2 class="text-xl font-semibold text-primary border-b border-border pb-2">基本信息</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <%= form.label :full_name, '姓名', class: "form-label" %>
                <%= form.text_field :full_name, required: true, class: "form-input", placeholder: "请输入您的姓名" %>
              </div>

              <div>
                <%= form.label :title, '职位/职称', class: "form-label" %>
                <%= form.text_field :title, required: true, class: "form-input", placeholder: "例如：资深律师、主任医师" %>
              </div>
            </div>

            <div>
              <%= form.label :company, '公司/机构', class: "form-label" %>
              <%= form.text_field :company, class: "form-input", placeholder: "请输入您所在的公司或机构" %>
            </div>
            
            <div>
              <%= form.label :slug, '名片链接', class: "form-label" %>
              <div class="flex items-center gap-2">
                <span class="text-secondary whitespace-nowrap">/c/</span>
                <%= form.text_field :slug, class: "form-input", placeholder: "例如：zhangsan 或 mitnickseng" %>
              </div>
              <div class="form-help">
                自定义您的名片链接，只能使用英文字母、数字和连字符。当前链接：
                <a href="<%= card_url(@profile) %>" target="_blank" class="text-primary hover:underline"><%= card_url(@profile) %></a>
              </div>
            </div>
          </div>

          <!-- Contact Information -->
          <div class="space-y-4">
            <h2 class="text-xl font-semibold text-primary border-b border-border pb-2">联系方式</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <%= form.label :phone, '电话', class: "form-label" %>
                <%= form.telephone_field :phone, class: "form-input", placeholder: "请输入联系电话" %>
              </div>

              <div>
                <%= form.label :email, '邮箱', class: "form-label" %>
                <%= form.email_field :email, class: "form-input", placeholder: "请输入联系邮箱" %>
              </div>
            </div>

            <div>
              <%= form.label :location, '地址', class: "form-label" %>
              <%= form.text_field :location, class: "form-input", placeholder: "请输入您的工作地址或所在城市" %>
            </div>
          </div>

          <!-- Profile Details -->
          <div class="space-y-4">
            <h2 class="text-xl font-semibold text-primary border-b border-border pb-2">个人简介</h2>
            
            <div>
              <%= form.label :bio, '详细介绍', class: "form-label" %>
              <%= form.text_area :bio, rows: 6, class: "form-input", placeholder: "请介绍您的专业背景、工作经验等..." %>
              <div class="form-help">在名片页面展示，让访客更了解您</div>
            </div>

            <div>
              <%= form.label :avatar, '头像', class: "form-label" %>
              
              <% if @profile.avatar.attached? %>
                <div class="mb-4">
                  <div class="flex items-center gap-4">
                    <div class="avatar avatar-lg">
                      <%= image_tag @profile.avatar, alt: @profile.full_name, class: "w-full h-full object-cover" %>
                    </div>
                    <div class="text-sm text-secondary">
                      当前头像
                    </div>
                  </div>
                </div>
              <% end %>
              
              <%= form.file_field :avatar, accept: "image/*", class: "form-input" %>
              <div class="form-help">支持 JPG、PNG、GIF 等图片格式，建议尺寸 400x400 像素</div>
            </div>

            <div data-controller="image-preview">
              <%= form.label :background_image, '背景图片', class: "form-label" %>
              
              <div class="space-y-3">
                <% if @profile.background_image.attached? %>
                  <div class="relative aspect-video bg-surface-elevated rounded-lg overflow-hidden">
                    <%= image_tag @profile.background_image, 
                        class: 'w-full h-full object-cover',
                        data: { image_preview_target: 'preview' } %>
                  </div>
                <% else %>
                  <div class="relative aspect-video bg-surface-elevated rounded-lg overflow-hidden border-2 border-dashed border-border">
                    <img src="" class="hidden w-full h-full object-cover" data-image-preview-target="preview">
                    <div class="w-full h-full flex flex-col items-center justify-center" data-image-preview-target="placeholder">
                      <svg class="w-12 h-12 text-primary/40 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                      </svg>
                      <p class="text-sm text-muted">上传背景图片</p>
                    </div>
                  </div>
                <% end %>
                
                <%= form.file_field :background_image, 
                    accept: "image/*", 
                    class: "hidden", 
                    id: "settings-background-image-input",
                    data: { 
                      image_preview_target: 'input',
                      action: 'change->image-preview#preview'
                    } %>
                <label for="settings-background-image-input" class="btn-outline cursor-pointer inline-flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                  上传背景图片
                </label>
                <div class="form-help">建议尺寸 1200x675 像素，用于展示在名片页面</div>
              </div>
            </div>
          </div>

          <!-- Specializations -->
          <div class="space-y-4">
            <h2 class="text-xl font-semibold text-primary border-b border-border pb-2">专业领域</h2>
            
            <div id="specializations-container">
              <% specializations = @profile.specializations_array %>
              <% specializations = [''] if specializations.empty? %>
              
              <% specializations.each_with_index do |spec, index| %>
                <div class="flex gap-2 mb-2">
                  <%= text_field_tag "profile[specializations][]", spec, 
                      class: "form-input flex-1", 
                      placeholder: "例如：民事诉讼、心血管疾病、财产保险" %>
                  <% if index > 0 %>
                    <button type="button" class="btn-ghost" onclick="this.parentElement.remove()">删除</button>
                  <% end %>
                </div>
              <% end %>
            </div>
            
            <button type="button" class="btn-outline" onclick="addSpecialization()">+ 添加专业领域</button>
          </div>

          <!-- Professional Stats -->
          <div class="space-y-4">
            <h2 class="text-xl font-semibold text-primary border-b border-border pb-2">专业数据</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <div>
                <%= form.label 'stats[years_experience]', '执业年限（年）', class: "form-label" %>
                <%= number_field_tag 'profile[stats][years_experience]', 
                    @profile.stats&.dig('years_experience'), 
                    class: "form-input", min: 0, placeholder: "0" %>
              </div>

              <div>
                <%= form.label 'stats[cases_handled]', '成功案例数', class: "form-label" %>
                <%= number_field_tag 'profile[stats][cases_handled]', 
                    @profile.stats&.dig('cases_handled'), 
                    class: "form-input", min: 0, placeholder: "0" %>
              </div>

              <div>
                <%= form.label 'stats[clients_served]', '服务客户数', class: "form-label" %>
                <%= number_field_tag 'profile[stats][clients_served]', 
                    @profile.stats&.dig('clients_served'), 
                    class: "form-input", min: 0, placeholder: "0" %>
              </div>

              <div>
                <%= form.label 'stats[success_rate]', '成功率（%）', class: "form-label" %>
                <%= number_field_tag 'profile[stats][success_rate]', 
                    @profile.stats&.dig('success_rate'), 
                    class: "form-input", min: 0, max: 100, placeholder: "0" %>
              </div>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="pt-6 border-t border-border">
            <div class="flex justify-end gap-3">
              <%= link_to "取消", dashboards_path, class: "btn-ghost" %>
              <%= form.submit "保存更改", class: "btn-primary" %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
function addSpecialization() {
  const container = document.getElementById('specializations-container');
  const div = document.createElement('div');
  div.className = 'flex gap-2 mb-2';
  div.innerHTML = `
    <input type="text" name="profile[specializations][]" class="form-input flex-1" placeholder="例如：民事诉讼、心血管疾病、财产保险">
    <button type="button" class="btn-ghost" onclick="this.parentElement.remove()">删除</button>
  `;
  container.appendChild(div);
}
</script>

<%= render 'shared/ai_assistant_widget' %>
