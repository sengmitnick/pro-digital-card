#!/usr/bin/env ruby
require 'fileutils'
require_relative '../lib/asset_helper'

APP_ROOT = File.expand_path('..', __dir__)

FileUtils.chdir APP_ROOT do
  puts 'ğŸ—ï¸  Pre-Deployment Build Validation'
  puts '====================================='
  puts ''

  # 1. Bundle check
  puts 'ğŸ’ Checking bundle dependencies...'
  unless system('bundle check', out: File::NULL, err: File::NULL)
    abort "\nâŒ Bundle check failed!\n\n   Run: bundle install\n"
  end
  puts 'âœ… Bundle dependencies satisfied'
  puts ''

  # 2. NPM dependencies
  puts 'ğŸ“¦ Checking npm dependencies...'
  unless File.exist?('node_modules')
    abort "\nâŒ node_modules not found!\n\n   Run: npm install\n"
  end
  puts 'âœ… NPM dependencies installed'
  puts ''

  # 3. Lint (TypeScript + ESLint)
  puts 'ğŸ” Running lint checks (TypeScript + ESLint)...'
  unless system('npm run lint', out: File::NULL, err: File::NULL)
    puts ''
    puts `npm run lint 2>&1`
    abort "\nâŒ Lint check failed!\n"
  end
  puts 'âœ… Lint checks passed'
  puts ''

  # 4. Asset compilation status
  puts 'ğŸ¨ Checking asset compilation status...'
  if AssetHelper.needs_compilation?
    abort "\nâŒ Assets need compilation!\n\n   Run: npm run build\n   Then re-run: bin/build_check\n"
  end
  puts 'âœ… Assets are up to date'
  puts ''

  # Success
  puts 'ğŸ‰ ========================================'
  puts '   âœ… All build checks passed!'
  puts '   Ready for deployment.'
  puts '========================================'
end
