#!/usr/bin/env ruby
require 'fileutils'

# path to your application root.
APP_ROOT = File.expand_path('..', __dir__)

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

def git_clean?
  # Refresh git index to avoid false positives from timestamp changes
  system('git update-index --refresh', out: File::NULL, err: File::NULL)
  system('git diff-index --quiet HEAD --', out: File::NULL, err: File::NULL)
end

def in_submodule?
  # Check if we're in a git submodule
  # In submodule, .git is a file (not directory) pointing to parent's .git/modules
  git_path = File.join(APP_ROOT, '.git')
  File.exist?(git_path) && File.file?(git_path)
end

def files_identical?(file1, file2)
  system("diff -q #{file1} #{file2}", out: File::NULL, err: File::NULL)
end

FileUtils.chdir APP_ROOT do
  puts '== Template Prebuild Check =='
  puts ''

  # Detect if we're in a submodule
  is_submodule = in_submodule?
  if is_submodule
    puts 'ğŸ” Detected git submodule environment'
    puts 'âš ï¸  Skipping git clean check and git pull (managed by parent project)'
    puts ''
  end

  # 0. Check if git status is clean (skip for submodules)
  unless is_submodule
    puts 'ğŸ“‹ Checking git status...'
    unless git_clean?
      abort "\nâŒ Git working directory is not clean!\n" +
            "Please commit or stash your changes before running this script.\n" +
            `git status`
    end
    puts 'âœ… Git working directory is clean'
    puts ''
  end

  # 1. Pull latest changes (skip for submodules)
  unless is_submodule
    puts 'ğŸ“¥ Pulling latest changes...'
    system! 'git pull --rebase'
    puts 'âœ… Successfully pulled latest changes'
    puts ''
  end

  # 2. Bundle install
  puts 'ğŸ’ Running bundle install...'
  system! 'bundle install'
  puts 'âœ… Bundle install completed'
  puts ''

  # 3. npm install
  puts 'ğŸ“¦ Running npm install...'
  system! 'npm install'
  puts 'âœ… npm install completed'
  puts ''

  # 4. Check if application.yml differs from application.yml.example
  puts 'ğŸ” Checking application.yml vs application.yml.example...'
  unless files_identical?('config/application.yml', 'config/application.yml.example')
    abort "\nâŒ application.yml differs from application.yml.example!\n" +
          "Please manually review and sync these files:\n\n" +
          `diff config/application.yml config/application.yml.example`
  end
  puts 'âœ… application.yml matches application.yml.example'
  puts ''

  # 5. Check if git status is still clean (skip for submodules)
  unless is_submodule
    puts 'ğŸ“‹ Final git status check...'
    unless git_clean?
      abort "\nâŒ Git working directory is not clean after updates!\n" +
            "Please review the changes:\n" +
            `git status`
    end
    puts 'âœ… Git working directory is still clean'
    puts ''
  end

  # 6. All checks passed
  puts 'ğŸ‰ ========================================'
  puts '   âœ… OK - All checks passed!'
  puts '   Template is ready for publishing.'
  puts '========================================'
end
