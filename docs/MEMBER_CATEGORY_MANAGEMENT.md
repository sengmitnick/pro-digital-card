# 成员类别管理功能文档

## 功能概述

成员类别管理功能允许管理员在管理后台查看和管理组织成员的类别分配情况。

## 功能位置

在管理后台侧边栏的"成员管理"下方，新增了"类别管理"菜单项。

## 路由配置

```ruby
namespace :admin do
  resources :member_categories, only: [:index, :update]
end
```

- **访问路径**: `/admin/member_categories`
- **控制器**: `Admin::MemberCategoriesController`

## 预定义的成员类别

在 `Profile` 模型中定义了以下固定类别：

```ruby
MEMBER_CATEGORIES = [
  '终身卡',
  '年度会员',
  '课次会员',
  '预科',
  '读书会'
].freeze
```

## 主要功能

### 1. 类别统计概览

显示三个关键指标：
- **总成员数**: 系统中所有成员的总数
- **已分类成员**: 已设置类别的成员数量
- **未分类成员**: 尚未设置类别的成员数量

### 2. 类别列表

展示所有预定义类别及其详细信息：
- 类别名称
- 该类别下的成员数量
- 该类别占总成员的百分比
- 快速链接到该类别的成员列表

### 3. 成员管理页面增强

在成员管理页面（`/admin/organization/members`）新增了：

#### 类别筛选器
- **全部**: 显示所有成员
- **按类别筛选**: 点击任意类别（终身卡、年度会员等）查看该类别的成员
- **未分类**: 查看所有未设置类别的成员

#### 类别显示
在成员列表的所有表格中（待审核、已批准、已拒绝），都显示成员的类别信息：
- 已设置类别：显示蓝色徽章
- 未设置类别：显示灰色"未设置"徽章

### 4. 个人资料编辑

在个人资料编辑页面（`/admin/profiles/:id/edit`）中，管理员可以：
- 从下拉菜单中选择成员类别
- 类别字段允许留空（未分类）

## 数据库字段

成员类别信息存储在 `profiles` 表的 `member_category` 字段中：
- 类型：`string`
- 允许为空：`true`
- 验证：必须是 `MEMBER_CATEGORIES` 中定义的值之一，或为空

## 快捷操作

类别管理页面提供了以下快捷操作入口：
1. **批量分配类别**: 为多个成员批量设置类别（链接到成员管理页面）
2. **导出类别报表**: 导出所有类别统计数据（待开发）

## 相关文件

### 控制器
- `app/controllers/admin/member_categories_controller.rb` - 类别管理控制器
- `app/controllers/admin/organizations_controller.rb` - 成员管理控制器（已更新支持类别筛选）

### 视图
- `app/views/admin/member_categories/index.html.erb` - 类别管理主页面
- `app/views/admin/organizations/members.html.erb` - 成员管理页面（已更新显示类别）
- `app/views/admin/profiles/edit.html.erb` - 个人资料编辑页面（包含类别选择）

### 模型
- `app/models/profile.rb` - 定义了 `MEMBER_CATEGORIES` 常量

### 路由
- `config/routes.rb` - 包含类别管理路由

### 测试
- `spec/requests/admin_member_categories_spec.rb` - 类别管理功能测试

## 使用流程

### 查看类别统计
1. 登录管理后台
2. 点击侧边栏的"类别管理"
3. 查看总览统计和详细类别列表

### 为成员分配类别
1. 在管理后台点击"个人资料"
2. 选择要编辑的成员
3. 在"学员类别"下拉菜单中选择类别
4. 保存更改

### 按类别筛选成员
1. 在管理后台点击"成员管理"
2. 使用页面顶部的类别筛选器
3. 点击任意类别按钮查看该类别的成员

### 查找未分类成员
1. 在管理后台点击"成员管理"
2. 点击"未分类"按钮
3. 系统显示所有未设置类别的成员

## 注意事项

1. **类别定义在代码中**: 类别列表在 `Profile::MEMBER_CATEGORIES` 中硬编码。如需添加或删除类别，需要修改模型代码。

2. **类别验证**: 系统会验证 `member_category` 必须是预定义类别之一，或为空值。

3. **未分类提醒**: 类别管理页面会显示未分类成员的数量，并提供快速链接到未分类成员列表。

4. **筛选持久化**: URL参数会保留筛选条件，方便分享特定筛选结果的链接。

## 未来扩展

可能的功能扩展方向：
- 批量分配类别功能的实现
- 导出类别报表功能
- 类别的动态管理（通过界面添加/删除类别）
- 类别的权限控制
- 类别的历史记录追踪
