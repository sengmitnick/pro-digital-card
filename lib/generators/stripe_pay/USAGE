Description:
    The stripe_pay generator creates a complete Stripe payment integration with a polymorphic Payment model.
    This allows one Payment model to work with ANY business model (Order, Subscription, Booking, Course, etc.)

Example:
    rails g stripe_pay
    rails g stripe_pay --auth

    This will create:
        Migration:  db/migrate/create_payments.rb (polymorphic payable, user reference)
        Model:      app/models/payment.rb
        Controller: app/controllers/payments_controller.rb
        Service:    app/services/stripe_payment_service.rb
        Views:      app/views/payments/_pay_button.html.erb (partial only)
                   app/views/payments/_payment_card.html.erb (partial only)
                   app/views/payments/pay.turbo_stream.erb
        Admin:      app/controllers/admin/payments_controller.rb
                   app/views/admin/payments/index.html.erb
                   app/views/admin/payments/show.html.erb
        Tests:      spec/requests/payments_spec.rb
                   spec/factories/payments.rb
        Config:     config/initializers/stripe.rb
        Routes:     Added to config/routes.rb

Options:
    --auth: Add user association to payments (requires User model)

After Generation:

1. Run setup:
   bundle install && rails db:migrate && touch tmp/restart.txt

2. Configure Stripe keys in config/application.yml

3. Create your business model and add payment association:

   # Example: One-time purchase (Order)
   rails g model Order user:references total:decimal status:string

   # In app/models/order.rb:
   class Order < ApplicationRecord
     belongs_to :user
     has_one :payment, as: :payable, dependent: :destroy

     def customer_name
       user.name
     end

     def customer_email
       user.email
     end

     def payment_description
       "Order ##{id}"
     end
   end

   # Example: Subscription (has many payments for recurring billing)
   rails g model Subscription user:references plan_name:string plan_price:decimal status:string stripe_subscription_id:string

   # In app/models/subscription.rb:
   class Subscription < ApplicationRecord
     belongs_to :user
     has_many :payments, as: :payable  # Multiple payments for recurring billing

     def customer_name
       user.name
     end

     def customer_email
       user.email
     end

     def payment_description
       "#{plan_name} - Monthly Subscription"
     end

     # Tell Payment Service to use subscription mode
     def stripe_mode
       'subscription'
     end

     # Dynamically create Stripe Price (no need to pre-create in Stripe Dashboard)
     # Perfect for templates - just works! No manual Stripe configuration needed.
     def stripe_line_items
       [{
         price_data: {
           currency: 'usd',
           product_data: {
             name: plan_name,
             description: "Monthly subscription to #{plan_name}"
           },
           unit_amount: (plan_price * 100).to_i,  # Convert dollars to cents
           recurring: { interval: 'month' }  # Can be 'day', 'week', 'month', or 'year'
         },
         quantity: 1
       }]
     end
   end

4. Create payment in your controller:

   # One-time purchase example:
   def create
     @order = current_user.orders.create!(order_params)
     @payment = @order.create_payment!(
       amount: @order.total,
       currency: 'usd',
       user: current_user
     )
     redirect_to payment_path(@payment)
   end

   # Subscription example:
   def subscribe
     @subscription = current_user.subscriptions.create!(plan: params[:plan])
     @payment = @subscription.payments.create!(
       amount: plan_price,
       currency: 'usd',
       user: current_user
     )
     redirect_to payment_path(@payment)
   end

5. Create payment views:

   CRITICAL: You MUST create these views (NOT generated):
   - app/views/payments/show.html.erb
   - app/views/payments/success.html.erb

   Example show.html.erb:
   <div class="container py-12">
     <h1>Payment for <%= @payment.payable_type %> #<%= @payment.payable_id %></h1>

     <!-- Render your payable object -->
     <%= render @payment.payable if @payment.payable %>

     <div class="card mt-6">
       <div class="card-body">
         <p>Amount: <%= number_to_currency(@payment.amount) %></p>
         <p>Status: <%= @payment.status %></p>
       </div>
     </div>

     <!-- CRITICAL: Include pay button for unpaid payments -->
     <% if @payment.pending? || @payment.failed? %>
       <%= render 'payments/pay_button', payment: @payment %>
     <% end %>
   </div>

   Example success.html.erb:
   <div class="container py-12 text-center">
     <h1>Payment Successful!</h1>
     <p>Payment #<%= @payment.id %> has been completed.</p>
     <%= link_to "View #{@payment.payable_type}", @payment.payable, class: "btn-primary" %>
   </div>

6. Use payment button in your business views:

   <!-- In app/views/orders/show.html.erb -->
   <h1>Order #<%= @order.id %></h1>
   <!-- Your order details -->

   <% if @order.payment && !@order.payment.paid? %>
     <%= render 'payments/pay_button', payment: @order.payment %>
   <% end %>

   <!-- In app/views/subscriptions/show.html.erb -->
   <h1>Your Subscription</h1>
   <h2>Payment History</h2>
   <% @subscription.payments.each do |payment| %>
     <%= render 'payments/payment_card', payment: payment %>
   <% end %>

Payable Interface:

Your business model should implement these methods:

Required:
  - customer_name:  Returns name for Stripe (String)
  - customer_email: Returns email for Stripe (String)
  - payment_description: Returns product/service description (String)

Optional (for advanced use):
  - stripe_mode: Returns 'payment' or 'subscription' (String, default: 'payment')
  - stripe_line_items: Returns line items for Stripe checkout (Array)
      For subscriptions, use price_data with recurring parameter (see examples above)
      For one-time purchases, defaults to payment amount (no implementation needed)
  - on_payment_success(payment): Callback when payment succeeds

Webhook Handling:

The service handles these Stripe events automatically:
  - checkout.session.completed: Marks payment as paid
  - payment_intent.succeeded: Marks payment as paid
  - payment_intent.payment_failed: Marks payment as failed
  - invoice.payment_succeeded: For subscription renewals (requires custom implementation)
  - customer.subscription.*: For subscription updates (requires custom implementation)

Testing:

Use Stripe test cards in development:
  - Success: 4242 4242 4242 4242
  - Decline: 4000 0000 0000 0002
  - Any future expiry, any 3-digit CVC

Important Notes:

1. Payment vs Order:
   - Payment = Technical concept (handling money)
   - Order/Subscription/Booking = Business concept (your domain)
   - Keep them separate for maximum flexibility

2. One-time vs Subscription:
   - One-time: Order has_one :payment
   - Subscription: Subscription has_many :payments (first + renewals)

3. Views are intentionally minimal:
   - Only partials are generated
   - Full page views must be created by you
   - This allows complete customization for your business

4. User association is optional:
   - Supports normal case: payment.user == payable.user
   - Supports gift/proxy: payment.user != payable.user
   - Supports anonymous: payment.user = nil
